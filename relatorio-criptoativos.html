<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Interativo de Criptoativos</title>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The SPA is redesigned with a clear, task-oriented flow. It starts with an onboarding screen (onboarding state) to set context. Upon user action, it transitions to a dashboard state, which includes a central control panel for filters, a dynamic summary of key metrics, a core multi-dimensional bubble chart for high-level analysis, and a detailed grid of asset cards. This architecture is chosen to facilitate a user journey from "what is this?" to "let me see the data," and finally to "how can I explore it?". This logical progression improves usability and reduces cognitive load compared to a single-view, unfiltered approach. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Onboarding/Purpose. Goal: Inform. Viz/Method: Full-screen hero section with dynamic button text. Interaction: Click to load data and transition to dashboard. Justification: Sets a clear entry point and purpose for the user.
        - Report Info: Relationship between multiple assets' market cap, 24h change, and potential. Goal: Compare. Viz/Method: Bubble Chart (Chart.js Canvas). Interaction: Hover for details, updates with filters. Justification: Provides a dense, multi-dimensional overview superior to repeated small charts.
        - Report Info: Summary of key asset data. Goal: Inform. Viz/Method: HTML/CSS Cards. Interaction: Click to highlight on chart (future enhancement). Justification: Clear, scannable format for individual asset data. Category added for better context.
        - Report Info: User-defined criteria. Goal: Organize/Filter. Viz/Method: HTML Sliders and inputs. Interaction: User input triggers data filtering and re-rendering of the chart and grid. Justification: Core element for interactivity and data exploration.
        - Report Info: Aggregated data from the filtered set. Goal: Inform. Viz/Method: Dynamic text in HTML components. Interaction: Updates when filters change. Justification: Gives high-level context to the user's current view.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f7f6; color: #44403c; }
        .chart-container { position: relative; width: 100%; height: 50vh; max-height: 500px; }
        .slider-track { height: 6px; }
        .slider-thumb { appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 py-8 md:px-6 md:py-12">

        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-stone-800">Painel de Análise de Criptoativos</h1>
            <p class="mt-3 max-w-2xl mx-auto text-lg text-stone-600">Uma ferramenta interativa para explorar e analisar dados de criptomoedas em tempo real.</p>
        </header>

        <main>
             <section id="onboarding-screen" class="min-h-[60vh] flex flex-col items-center justify-center text-center">
                <h2 class="text-3xl md:text-4xl font-semibold text-stone-700 max-w-2xl">Explore o Universo das Criptomoedas</h2>
                <p class="mt-4 text-lg text-stone-600 max-w-xl">
                    Este relatório interativo traduz dados complexos do mercado de criptoativos em visualizações claras e intuitivas. Comece a análise para descobrir insights sobre o potencial, market cap e performance de diversos ativos.
                </p>
                <button id="api-button" class="mt-8 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition-all flex items-center justify-center gap-2 disabled:bg-indigo-400 disabled:cursor-not-allowed">
                    <span id="button-text">Iniciar Análise</span>
                    <div id="loading-spinner" class="spinner hidden"></div>
                </button>
                <div id="status-message" class="mt-4 text-sm text-stone-600 h-5"></div>
            </section>

            <div id="dashboard-content" class="hidden fade-in">
                 <section id="controls" class="mb-10 p-6 bg-white rounded-2xl shadow-sm border border-stone-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div>
                            <label for="marketCapFilter" class="block text-sm font-medium text-stone-700">Filtrar por Market Cap</label>
                            <p class="text-xs text-stone-500 mb-2">Exibe ativos com Market Cap até o valor selecionado.</p>
                            <input id="marketCapFilter" type="range" min="0" max="10000000000" value="10000000000" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer slider-thumb bg-indigo-600">
                            <div class="text-xs text-stone-500 mt-1">Até <span id="marketCapValue" class="font-bold text-stone-800">$10B+</span></div>
                        </div>
                        <div>
                            <label for="potentialScoreFilter" class="block text-sm font-medium text-stone-700">Filtrar por Pontuação de Potencial</label>
                            <p class="text-xs text-stone-500 mb-2">Exibe ativos com pontuação de potencial acima do valor mínimo.</p>
                            <input id="potentialScoreFilter" type="range" min="0" max="10" value="0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer slider-thumb bg-indigo-600">
                            <div class="text-xs text-stone-500 mt-1">Mínimo de <span id="potentialScoreValue" class="font-bold text-stone-800">0</span></div>
                        </div>
                    </div>
                </section>
                
                 <section id="key-metrics" class="mb-10">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-200"><p class="text-sm text-stone-500">Ativos Exibidos</p><p id="assets-displayed" class="text-2xl font-bold text-indigo-600">0</p></div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-200"><p class="text-sm text-stone-500">Market Cap Total</p><p id="total-market-cap" class="text-2xl font-bold text-indigo-600">$0</p></div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-200"><p class="text-sm text-stone-500">Volume (24h)</p><p id="total-volume" class="text-2xl font-bold text-indigo-600">$0</p></div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-200"><p class="text-sm text-stone-500">Mudança Média (24h)</p><p id="avg-change" class="text-2xl font-bold text-stone-800">0.00%</p></div>
                    </div>
                </section>
                
                <section id="main-chart-section" class="mb-10 p-6 bg-white rounded-2xl shadow-sm border border-stone-200">
                     <h2 class="text-2xl font-bold text-stone-800 mb-1">Análise Comparativa de Criptoativos</h2>
                     <p class="text-stone-600 mb-4">Cada bolha representa um ativo. O <strong>eixo X</strong> mostra o Market Cap (escala logarítmica), o <strong>eixo Y</strong> a Variação de Preço em 24h, e o <strong>tamanho</strong> da bolha a Pontuação de Potencial.</p>
                    <div class="chart-container">
                        <canvas id="bubbleChart"></canvas>
                    </div>
                </section>

                <section id="asset-grid-section">
                     <h2 class="text-2xl font-bold text-stone-800 mb-4">Ativos Filtrados</h2>
                    <div id="asset-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Asset cards will be injected here -->
                    </div>
                     <p id="no-assets-message" class="text-center text-stone-500 col-span-full py-10 hidden">Nenhum ativo corresponde aos filtros selecionados.</p>
                </section>
            </div>
        </main>
        
        <footer class="text-center border-t border-stone-200 pt-6 mt-12">
            <p class="text-stone-500 text-sm"><strong>Aviso Legal:</strong> Este relatório é gerado para fins educacionais e não constitui aconselhamento financeiro. A pontuação de potencial é baseada em um modelo algorítmico e não garante lucros.</p>
        </footer>
    </div>

    <script>
        let masterAssetList = [];
        let filteredAssetList = [];
        let mainChart;

        const formatNumber = (num, compact = true) => {
            if (num === null || num === undefined) return 'N/A';
            if (compact) {
                if (num >= 1e12) return `$${(num / 1e12).toFixed(2)}T`;
                if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
                if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            }
            if (num > 0 && num < 0.01) return `$${num.toPrecision(2)}`;
            return `$${num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        const calculatePotentialScore = (asset) => {
            if (!asset || asset.market_cap === 0) return 0;
            let score = 0;
            
            // 1. Fator de Market Cap (Market Cap Rank Inverso)
            // Moedas com rank mais baixo recebem pontuação maior
            const marketCapRankWeight = 0.3;
            const marketCapRankFactor = 100 - (asset.market_cap_rank || 100);
            score += marketCapRankFactor * marketCapRankWeight;

            // 2. Fator de Tendência de Preço (Mudanças de 24h, 7d, 30d)
            // Pondera mais a tendência de longo prazo
            const priceChangeWeight = 0.5;
            const change24h = asset.price_change_percentage_24h || 0;
            const change7d = asset.price_change_percentage_7d_in_currency || 0;
            const change30d = asset.price_change_percentage_30d_in_currency || 0;
            const trendScore = (change24h * 0.2) + (change7d * 0.3) + (change30d * 0.5);
            score += trendScore * priceChangeWeight;
            
            // 3. Fator de Volatilidade (Risco/Recompensa)
            // Usa a diferença entre a máxima e a mínima das últimas 24h
            const volatilityWeight = 0.1;
            const highLowDiff = (asset.high_24h - asset.low_24h) || 0;
            const volatilityScore = asset.low_24h > 0 ? (highLowDiff / asset.low_24h) * 10 : 0;
            score += volatilityScore * volatilityWeight;

            // 4. Fator de Engajamento da Comunidade (Votos de Sentimento)
            const sentimentWeight = 0.1;
            const sentimentUp = asset.sentiment_votes_up_percentage || 0;
            score += sentimentUp / 10 * sentimentWeight; // Normaliza para 0-10

            // Normaliza a pontuação final para uma escala de 0 a 10
            const normalizedScore = (score / (100 * marketCapRankWeight + 10 * priceChangeWeight + 10 * volatilityWeight + 10 * sentimentWeight)) * 10;
            return Math.max(0, Math.min(10, normalizedScore));
        };
        
        const getScoreLabel = (score) => {
            if (score >= 8) return { label: 'Altíssimo', color: 'bg-emerald-100 text-emerald-800' };
            if (score >= 6) return { label: 'Alto', color: 'bg-teal-100 text-teal-800' };
            if (score >= 4) return { label: 'Moderado', color: 'bg-amber-100 text-amber-800' };
            return { label: 'Baixo', color: 'bg-rose-100 text-rose-800' };
        };

        const createAssetCard = (asset) => {
            const { label: scoreLabel, color: scoreColor } = getScoreLabel(asset.score);
            const priceChange24h = asset.price_change_percentage_24h || 0;
            const priceChangeText = `${priceChange24h.toFixed(2)}%`;
            const priceChangeColor = priceChange24h >= 0 ? 'text-green-600' : 'text-red-600';
            const categoryText = asset.category || 'Não Categorizado';

            return `
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-stone-200 hover:shadow-md hover:border-indigo-300 transition-all">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-stone-800">${asset.name}</h3>
                            <p class="text-sm text-stone-500 uppercase">${asset.symbol}</p>
                        </div>
                        <div class="flex items-center gap-2">
                           <div class="text-xs font-bold px-2 py-1 rounded-full bg-stone-100 text-stone-600">${categoryText}</div>
                           <div class="text-xs font-bold px-2 py-1 rounded-full ${scoreColor}">${scoreLabel}</div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-xs text-stone-500">Preço</p>
                            <p class="font-semibold text-stone-800 text-lg">${formatNumber(asset.current_price, false)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-stone-500">Market Cap</p>
                            <p class="font-semibold text-stone-800 text-lg">${formatNumber(asset.market_cap)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-stone-500">MUDANÇA 24h</p>
                            <p class="font-semibold ${priceChangeColor} text-lg">${priceChangeText}</p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderDashboard = () => {
            const grid = document.getElementById('asset-grid');
            const metricsDisplayed = document.getElementById('assets-displayed');
            const metricsMarketCap = document.getElementById('total-market-cap');
            const metricsVolume = document.getElementById('total-volume');
            const metricsAvgChange = document.getElementById('avg-change');
            const noAssetsMessage = document.getElementById('no-assets-message');
            
            if (filteredAssetList.length === 0) {
                grid.innerHTML = '';
                noAssetsMessage.classList.remove('hidden');
            } else {
                grid.innerHTML = filteredAssetList.map(createAssetCard).join('');
                noAssetsMessage.classList.add('hidden');
            }

            const totalMarketCap = filteredAssetList.reduce((sum, asset) => sum + (asset.market_cap || 0), 0);
            const totalVolume = filteredAssetList.reduce((sum, asset) => sum + (asset.total_volume || 0), 0);
            const avgChange = filteredAssetList.length > 0
                ? filteredAssetList.reduce((sum, asset) => sum + (asset.price_change_percentage_24h || 0), 0) / filteredAssetList.length
                : 0;

            metricsDisplayed.textContent = filteredAssetList.length;
            metricsMarketCap.textContent = formatNumber(totalMarketCap);
            metricsVolume.textContent = formatNumber(totalVolume);
            metricsAvgChange.textContent = `${avgChange.toFixed(2)}%`;
            metricsAvgChange.className = `text-2xl font-bold ${avgChange >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            updateBubbleChart();
        };

        const updateBubbleChart = () => {
            if (!mainChart) {
                const ctx = document.getElementById('bubbleChart').getContext('2d');
                mainChart = new Chart(ctx, {
                    type: 'bubble',
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const d = context.raw;
                                        return `${d.name} | Potencial: ${d.r.toFixed(2)} | MC: ${formatNumber(d.x)} | 24h: ${d.y.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Market Cap (Logarítmico)' },
                                type: 'logarithmic',
                                ticks: {
                                    callback: function(value) {
                                        return formatNumber(value);
                                    }
                                }
                            },
                            y: {
                                title: { display: true, text: 'Variação de Preço 24h (%)' }
                            }
                        }
                    }
                });
            }

            mainChart.data.datasets = [{
                label: 'Criptoativos',
                data: filteredAssetList.map(asset => ({
                    x: Math.max(1, asset.market_cap || 1), 
                    y: asset.price_change_percentage_24h || 0,
                    r: asset.score * 2 + 3,
                    name: asset.name
                })),
                backgroundColor: 'rgba(79, 70, 229, 0.6)',
                borderColor: 'rgba(79, 70, 229, 1)',
            }];
            mainChart.update();
        };
        
        const applyFilters = () => {
            const marketCapFilter = document.getElementById('marketCapFilter').value;
            const potentialScoreFilter = document.getElementById('potentialScoreFilter').value;
            
            filteredAssetList = masterAssetList.filter(asset => {
                const mcCondition = asset.market_cap <= marketCapFilter;
                const scoreCondition = asset.score >= potentialScoreFilter;
                return mcCondition && scoreCondition;
            });
            renderDashboard();
        };

        const setupControls = () => {
            const marketCapFilter = document.getElementById('marketCapFilter');
            const marketCapValue = document.getElementById('marketCapValue');
            const potentialScoreFilter = document.getElementById('potentialScoreFilter');
            const potentialScoreValue = document.getElementById('potentialScoreValue');
            
            const maxMarketCap = Math.max(...masterAssetList.map(a => a.market_cap || 0));
            marketCapFilter.max = maxMarketCap;
            marketCapFilter.value = maxMarketCap;
            marketCapValue.textContent = formatNumber(maxMarketCap);

            marketCapFilter.addEventListener('input', () => {
                marketCapValue.textContent = formatNumber(marketCapFilter.value);
                applyFilters();
            });
            potentialScoreFilter.addEventListener('input', () => {
                potentialScoreValue.textContent = potentialScoreFilter.value;
                applyFilters();
            });
        };
        
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const fetchDataFromAPI = async () => {
            document.getElementById('api-button').disabled = true;
            document.getElementById('button-text').textContent = 'Buscando...';
            document.getElementById('loading-spinner').classList.remove('hidden');
            const status = document.getElementById('status-message');
            status.textContent = 'Buscando dados primários...';
            
            const apiKey = 'CG-yd15f3vAJQP8GNw94nKVQjW2'; 
            const vsCurrency = 'usd';

            try {
                // Nova URL com dados de 7 e 30 dias
                const marketsUrl = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=${vsCurrency}&order=market_cap_desc&per_page=250&page=1&price_change_percentage=7d,30d&x_cg_demo_api_key=${apiKey}`;
                const marketsResponse = await fetch(marketsUrl);
                if (!marketsResponse.ok) throw new Error(`Erro na busca de dados: ${marketsResponse.status}`);
                
                let marketData = await marketsResponse.json();
                
                const allIds = [...new Set(marketData.map(c => c.id))];
                const coinDetails = [];
                const requestDelayMs = 2000;
                
                for (let i = 0; i < allIds.length; i++) {
                    const id = allIds[i];
                    status.textContent = `Processando ${i + 1} de ${allIds.length}...`;
                    try {
                        const response = await fetch(`https://api.coingecko.com/api/v3/coins/${id}?localization=false&tickers=false&market_data=false&community_data=true&developer_data=false&x_cg_demo_api_key=${apiKey}`);
                        if (response.ok) {
                            const data = await response.json();
                            coinDetails.push(data);
                        }
                    } catch (e) { console.error(`Falha ao buscar detalhes para ${id}`, e); }
                    await sleep(requestDelayMs);
                }

                const detailsMap = coinDetails.reduce((map, coin) => {
                    if (coin.id) map[coin.id] = { 
                        sentiment_votes_up_percentage: coin.sentiment_votes_up_percentage,
                        category: coin.categories && coin.categories.length > 0 ? coin.categories[0] : 'Geral'
                    };
                    return map;
                }, {});

                masterAssetList = marketData.map(coin => {
                    const enrichedCoin = {
                        ...coin,
                        sentiment_votes_up_percentage: detailsMap[coin.id]?.sentiment_votes_up_percentage,
                        category: detailsMap[coin.id]?.category
                    };
                    return { ...enrichedCoin, score: calculatePotentialScore(enrichedCoin) };
                });
                
                filteredAssetList = [...masterAssetList];
                
                document.getElementById('onboarding-screen').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');
                
                setupControls();
                renderDashboard();
                status.textContent = 'Dados atualizados com sucesso!';

            } catch (e) {
                status.textContent = `Erro: ${e.message}. Tente novamente.`;
            } finally {
                document.getElementById('api-button').disabled = false;
                document.getElementById('button-text').textContent = 'Iniciar Análise';
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        };

        document.getElementById('api-button').addEventListener('click', fetchDataFromAPI);
    </script>
</body>
</html>
